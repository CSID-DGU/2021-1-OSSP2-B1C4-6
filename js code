var mysql = require('mysql');
var express = require('express');
var bodyParser = require('body-parser');
var app = express();
var port = 3000;

app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json({ extended: true }));

app.listen(port, function () {
    console.log('Starting Server...');
});

var connection = mysql.createConnection({
    host: "",
    user: "",
    database: "TOUR",
    password: "",
    port: 3306
});

//---------------------------register/login
app.post('/user/register', function (req, res) {
    var UserName = req.body.UserName;
    var UserId = req.body.UserId;
    var UserPwd = req.body.UserPwd;
    var UserSex = req.body.UserSex;
    var UserAge = req.body.UserAge;
    var UserNation = req.body.UserNation;

    var sql = 'insert into UserInfo (UserName, UserId, UserPwd, UserSex, UserAge, UserNation) values (?, ?, ?, ?, ?, ?)';
    var params = [UserName, UserId, UserPwd, UserSex, UserAge, UserNation];

    connection.query(sql, params, function(err, result){
        if(err)
        console.log(err);
        else{
            res.json({
                'success': true,
                'message': '회원가입에 성공하셨습니다.'
            });
        }
    });
});

app.post('/user/login', function (req, res) {
    var UserId = req.body.UserId;
    var UserPwd = req.body.UserPwd;

    var sql = 'select * from UserInfo where UserId = ?';

    connection.query(sql, UserId, function(err, result){
        if(err) {
            console.log(err);
        } else{
            if (result.length == 0){
                res.json({
                    'success' : false,
                    'message': '존재하지 않는 계정입니다.'
                });
            } else if (UserPwd != result[0].UserPwd){
                res.json({
                    'success' : false,
                    'message': '비밀번호가 틀렸습니다.'
                });
            } else {
                res.json({
                    'success' : true,
                    'message': '로그인 성공!' + result[0].UserId + '님 환영합니다.'
                });
            }
        }
    });
});

app.post('/user/check', function (req, res) {
    var UserId = req.body.UserId;

    var sql = 'select * from UserInfo where UserId = ?';

    connection.query(sql, UserId, function(err, result){
        if(err){
            console.log(err);
        } else {
            if(result.length != 0) {
                res.json({
                    'success' : false,
                    'message' : '이미 존재하는 아이디입니다.'
                });
            } else {
                res.json({
                    'success' : true,
                    'message' : '사용 가능한 아이디입니다.'
                });
            }
        }
    });
});

//---------------------------archi 
//건축물 정보 호출
app.post('/archi/info', function (req, res) {
    var ApiName = req.body.ApiName; 
  
    var sql = 'select ArchiName, ArchiHistory, ArchiExplain, ArchiIssue, ArchiMaker from ArchiInfo where ApiName = ?';

    connection.query(sql, ApiName, function(err, result){
        if(err)
            console.log(err);
        else{
            res.json({
                'name': result[0].ArchiName,
                'history': result[0].ArchiHistory,
                'explain': result[0].ArchiExplain,
                'issue': result[0].ArchiIssue,
                'maker': result[0].ArchiMaker
            });
        }
    });
});

//사용자 검색 내역 저장: 사용자 아이디, 검색한 건축물 이름, 검색한 시간을 넘겨 받는다.
app.post('/archi/record', function (req, res) {
    var RecoUser = req.body.RecoUser;
    var RecoArchi = req.body.RecoArchi;
    var RecoTime = req.body.RecoTime;

    var sql = 'insert into ArchiReco (RecoUser, RecoArchi, RecoTime) values (?, ?, ?)';
    var params = [RecoUser, RecoArchi, RecoTime];

    connection.query(sql, params, function(err, result){
        if(err)
            console.log(err);
        else{
            res.json({
                'success': true,
                'message': '검색 기록에 성공하셨습니다.'
            });
        }
    });
});

//사용자 검색 내역 조회: 사용자 아이디를 넘겨 받는다.
app.post('/archi/list', function (req, res) {
    var RecoUser = req.body.RecoUser; 
  
    var sql = 'select distinct RecoArchi, RecoTime from ArchiReco where RecoUser = ? order by RecoTime desc';

    connection.query(sql, RecoUser, function(err, result){
        if (err)
            console.log(err);
        else {
            if (result.length == 0) {
                res.json({
                    'message': '검색 내역이 없습니다.',
                    result: result
                });
            } else {
                res.json({
                    'message': '검색 내역을 출력합니다.',
                    result: result
                });
            }
        }
    });
});

//사진에 대한 api는 임시로 짜놓은 것이니, 일단 무시하시고! 일요일날 얘기해봐야 할 거 같아요~
app.post('/archi/list/photo', function (req, res) {
    var RecoUser = req.body.RecoUser; 
    var RecoArchi = req.body.RecoArchi;
    var RecoTime = req.body.RecoTime;
  
    var sql = 'select RecoPhoto from RecoArchi where RecoUser = ? and RecoArchi = ? and RecoTime =?';
    var params = [RecoUser, RecoArchi, RecoTime];

    connection.query(sql, params, function(err, result){
        if (err)
            console.log(err);
        else {
            if (result.length == 0) {
                res.json({
                    'message': '해당 기록의 사진이 없습니다.',
                    result: result
                });
            } else {
                res.json({
                    'message': '해당 기록의 사진을 출력합니다.',
                    result: result
                });
            }
        }
    });
});
